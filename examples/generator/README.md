# Maximum performance with static slots and `virtual_ptr`

As described in the documentation of `generator`, static slots, in combination
with `virtual_ptr`, make open methods faster than virtual functions. This
example demonstrates how to use the feature and organize a cmake-based project.


## Project structure

The project consists of a collection of domain classes and methods, a generator
program, and an application.

The domain classes are a subset (`Animal`, `Cat` and `Dog`) of the synopsis
example. They are declared in a [header](animals.hpp), along with two methods
(`kick` and `meet`). [animal.cpp](animal.cpp) provides the implementation of the
classes and methods. For comparison, the Animal hierarchy also has a `kick`
virtual function.

`animals.hpp` contains a conditional include directive:

```c++
#if __has_include("slots.hpp")
#include "slots.hpp"
#endif
```

This header is not source code, and it is not checked in the repository; instead
it is generated by


## Building

## Performance

virtual function call

```asm
        mov     rax, qword ptr [rdi]
        jmp     qword ptr [rax + 16]
```

method, via virtual_ptr, dynamic offsets
```asm
        mov     rax, qword ptr [rip + method<kick, void (virtual_ptr<Animal>)>::fn]
        mov     rax, qword ptr [rsi + 8*rax]
        jmp     rax
```

method, via virtual_ptr, static offsets
```asm
        mov     rax, qword ptr [rsi + 16]
        jmp     rax
```

2-method, virtual_ptr, dynamic offsets
```asm
        mov     rax, qword ptr [rip + method<meet, void (virtual_ptr<Animal>, virtual_ptr<Animal>)>::fn]
        mov     rax, qword ptr [rsi + 8*rax]
        mov     r8, qword ptr [rip + method<meet, void (virtual_ptr<Animal>, virtual_ptr<Animal>)>::fn+8]
        mov     r8, qword ptr [rcx + 8*r8]
        imul    r8, qword ptr [rip + method<meet, void (virtual_ptr<Animal>, virtual_ptr<Animal>)>::fn+16]
        mov     rax, qword ptr [rax + 8*r8]
        jmp     rax
```


2-method, virtual_ptr, static offsets
```asm
        mov     rax, qword ptr [rsi]
        mov     r8, qword ptr [rcx + 8]
        lea     r8, [r8 + 2*r8]
        mov     rax, qword ptr [rax + 8*r8]
        jmp     rax
```
